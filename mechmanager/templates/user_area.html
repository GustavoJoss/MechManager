{% extends "base.html" %}
{% block content %}
<h1 class="h4 mb-3">Bem-vindo, {{ username }}!</h1>

<h2 class="h5 mt-4">Minha Área</h2>

<h3 class="h6 mt-3">Meus veículos recentes</h3>
<ul class="list-group mb-4">
  {% for v in vehicles %}
    <li class="list-group-item">{{ v.plate }} — {{ v.make }} {{ v.model }} ({{ v.year }})</li>
  {% empty %}
    <li class="list-group-item text-muted">Nenhum veículo cadastrado.</li>
  {% endfor %}
</ul>

<h3 class="h6">Minhas últimas OS</h3>
<table class="table table-striped align-middle">
  <thead>
    <tr>
      <th>#</th>
      <th>Cliente</th>
      <th>Placa</th>
      <th>Serviço</th>
      <th>Total</th>
      <th>Tempo estimado</th>
      <th>Ações</th>
    </tr>
  </thead>
  <tbody>
  {% for os in orders %}
    <tr id="os-{{ os.id }}">
      <td>{{ os.id }}</td>
      <td>{{ os.vehicle.owner.username }}</td>
      <td>{{ os.vehicle.plate }}</td>
      <td>{{ os.title|default:"—" }}</td>
      <td>R$ {{ os.total }}</td>
      <td>
        {{ os.total_minutes }} min
        <span class="text-muted">(~{{ os.total_hours }} h / {{ os.total_human }})</span>
      </td>
      <td class="d-flex gap-2">
        {% if not os.customer_confirmed %}
          <button type="button" class="btn btn-success btn-sm btn-confirmar" data-id="{{ os.id }}">
            Confirmar
          </button>
        {% else %}
          <span class="badge bg-success">Confirmada</span>
        {% endif %}
        <button type="button" class="btn btn-outline-secondary btn-sm btn-detalhes" data-id="{{ os.id }}">
          Detalhes
        </button>
      </td>
    </tr>
  {% empty %}
    <tr><td colspan="7" class="text-center text-muted">Nenhuma ordem de serviço encontrada.</td></tr>
  {% endfor %}
  </tbody>
</table>

<!-- Modal Detalhes -->
<div class="modal fade" id="osDetailModal" tabindex="-1" aria-labelledby="osDetailLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-6" id="osDetailLabel">Detalhes da OS #<span id="os-id"></span></h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2"><strong>Cliente:</strong> <span id="os-customer"></span></div>
        <div class="mb-2"><strong>Veículo:</strong> <span id="os-vehicle"></span></div>
        <div class="mb-2">
          <strong>Observações:</strong>
          <p id="os-notes" class="mb-0 text-pre-wrap text-muted">—</p>
        </div>
        <div class="mb-2">
          <strong>Itens:</strong>
          <div class="table-responsive">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Serviço</th>
                  <th class="text-end">Qtd</th>
                  <th class="text-end">Unitário</th>
                  <th class="text-end">Total</th>
                </tr>
              </thead>
              <tbody id="os-items"></tbody>
            </table>
          </div>
        </div>
        <div class="text-end">
          <div><strong>Tempo estimado:</strong> <span id="os-time"></span></div>
          <div><strong>Total:</strong> <span id="os-total"></span></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-light" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>

<style>
.text-pre-wrap { white-space: pre-wrap; }
</style>

<script>
(() => {
  const brl = (n) => isFinite(n) ? n.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}) : '—';

  // Abrir modal Detalhes
  document.addEventListener('click', async (e) => {
    const btn = e.target.closest('.btn-detalhes');
    if (!btn) return;

    const id = btn.getAttribute('data-id');
    try {
      const resp = await fetch(`/orders/${id}/`, { method: 'GET' });
      if (!resp.ok) throw new Error('Falha ao carregar detalhes.');
      const data = await resp.json();

      // Campos básicos
      document.getElementById('os-id').textContent = data.id ?? '';
      document.getElementById('os-customer').textContent = data.customer ?? '';
      document.getElementById('os-vehicle').textContent = data.vehicle
        ? `${data.vehicle.plate} — ${data.vehicle.make || ''} ${data.vehicle.model || ''} (${data.vehicle.year || ''})`
        : '';
      document.getElementById('os-notes').textContent = (data.notes && data.notes.trim()) ? data.notes : 'Sem observações.';

      // Itens
      const tbody = document.getElementById('os-items');
      tbody.innerHTML = '';
      (data.items || []).forEach(it => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${it.service || ''}</td>
          <td class="text-end">${it.quantity ?? 0}</td>
          <td class="text-end">${brl(it.unit_price ?? 0)}</td>
          <td class="text-end">${brl(it.total ?? 0)}</td>
        `;
        tbody.appendChild(tr);
      });

      // Totais
      const mins = data.estimated_total_minutes ?? 0;
      const hours = data.estimated_total_hours ?? (mins/60).toFixed(1);
      document.getElementById('os-time').textContent = `${mins} min (~${hours} h)`;
      document.getElementById('os-total').textContent = brl(data.total ?? 0);

      // Abre modal
      const modal = new bootstrap.Modal(document.getElementById('osDetailModal'));
      modal.show();

    } catch (err) {
      console.error(err);
      alert('Não foi possível carregar os detalhes da OS.');
    }
  });

  // Confirmar OS (POST JSON)
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }
  const csrf = getCookie('csrftoken');

  document.addEventListener('click', async (e) => {
    const btn = e.target.closest('.btn-confirmar');
    if (!btn) return;

    const id = btn.getAttribute('data-id');
    if (!window.confirm('Confirmar esta Ordem de Serviço?')) return;

    const resp = await fetch(`/os/${id}/confirmar/`, {
      method: 'POST',
      headers: { 'X-CSRFToken': csrf },
    });

    if (resp.ok) {
      const row = document.getElementById(`os-${id}`);
      if (row) row.remove();
    } else {
      alert('Não foi possível confirmar. Tente novamente.');
    }
  });
})();
</script>
{% endblock %}
